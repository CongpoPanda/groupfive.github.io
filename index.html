<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Group 5 Weather Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0b1726;
      color: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
    }
    .status {
      text-align: center;
      margin-bottom: 20px;
      font-size: 0.9rem;
      color: #aaa;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      max-width: 900px;
      margin: 0 auto;
    }
    .card {
      background: #182335;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    }
    .card-title {
      font-size: 0.9rem;
      color: #ffda79;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .card-value {
      font-size: 1.6rem;
      font-weight: bold;
    }
    .emoji {
      font-size: 2rem;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <h1>GROUP 5 WEATHER DASHBOARD</h1>
  <div class="status" id="connStatus">Connecting to MQTT...</div>

  <div class="grid">
    <div class="card">
      <div class="card-title">Temperature (Â°C)</div>
      <div class="card-value" id="tempVal">--</div>
    </div>
    <div class="card">
      <div class="card-title">Humidity (%)</div>
      <div class="card-value" id="humVal">--</div>
    </div>
    <div class="card">
      <div class="card-title">Pressure (hPa)</div>
      <div class="card-value" id="pressVal">--</div>
    </div>
    <div class="card">
      <div class="card-title">Wind Speed (m/s)</div>
      <div class="card-value" id="windSpeedVal">--</div>
    </div>
    <div class="card">
      <div class="card-title">Wind Direction</div>
      <div class="card-value" id="windDirVal">--</div>
    </div>
    <div class="card">
      <div class="card-title">Rain Status</div>
      <div class="card-value" id="rainVal">--</div>
    </div>
  </div>

  <!-- MQTT over WebSocket client (Paho) -->
  <script src="https://unpkg.com/paho-mqtt/mqttws31.min.js"></script>
  <script>
    // ==== CONFIG: Palitan mo ito ayon sa HiveMQ Cloud mo ====
    const MQTT_HOST = "wss://cef384719390434ea2501c6c4845c027.s1.eu.hivemq.cloud:8884/mqtt";
    const MQTT_USER = "LerDemo1";
    const MQTT_PASS = "LerDemo1";

    const tempTopic     = "cpe102/group5/temperature";
    const humTopic      = "cpe102/group5/humidity";
    const pressureTopic = "cpe102/group5/pressure";
    const windSpeedTopic= "cpe102/group5/windspeed";
    const windDirTopic  = "cpe102/group5/winddir";
    const rainTopic     = "cpe102/group5/rain";

    const connStatusEl  = document.getElementById("connStatus");
    const tempEl        = document.getElementById("tempVal");
    const humEl         = document.getElementById("humVal");
    const pressEl       = document.getElementById("pressVal");
    const windSpeedEl   = document.getElementById("windSpeedVal");
    const windDirEl     = document.getElementById("windDirVal");
    const rainEl        = document.getElementById("rainVal");

    // Parse wss URL para makuha host at path
    const url = new URL(MQTT_HOST);
    const clientId = "WebDash-" + Math.floor(Math.random() * 0xffff).toString(16);

    // Paho client: host, port, path, clientId
    const client = new Paho.MQTT.Client(
      url.hostname,
      Number(url.port),
      url.pathname,
      clientId
    );

    client.onConnectionLost = function(responseObject) {
      connStatusEl.textContent = "Disconnected from MQTT. Reconnecting...";
      console.log("Connection lost: ", responseObject.errorMessage);
      setTimeout(connectMQTT, 3000);
    };

    client.onMessageArrived = function(message) {
      const topic = message.destinationName;
      const payload = message.payloadString;
      console.log("MQTT MSG:", topic, payload);

      if (topic === tempTopic) {
        tempEl.textContent = parseFloat(payload).toFixed(1);
      } else if (topic === humTopic) {
        humEl.textContent = parseFloat(payload).toFixed(1);
      } else if (topic === pressureTopic) {
        pressEl.textContent = parseFloat(payload).toFixed(1);
      } else if (topic === windSpeedTopic) {
        windSpeedEl.textContent = parseFloat(payload).toFixed(2);
      } else if (topic === windDirTopic) {
        windDirEl.textContent = payload;
      } else if (topic === rainTopic) {
        // RAIN LOGIC HERE
        if (payload === "RAIN") {
          rainEl.innerHTML = 'Raining <span class="emoji">ðŸŒ§</span>';
        } else if (payload === "NO_RAIN") {
          rainEl.innerHTML = 'Sunny Weather <span class="emoji">â˜€</span>';
        } else {
          rainEl.textContent = "--";
        }
      }
    };

    function connectMQTT() {
      connStatusEl.textContent = "Connecting to MQTT...";
      const options = {
        useSSL: true,
        userName: MQTT_USER,
        password: MQTT_PASS,
        timeout: 5,
        onSuccess: function() {
          connStatusEl.textContent = "Connected to MQTT";
          console.log("MQTT connected");
          // Subscribe sa lahat ng topics
          client.subscribe(tempTopic);
          client.subscribe(humTopic);
          client.subscribe(pressureTopic);
          client.subscribe(windSpeedTopic);
          client.subscribe(windDirTopic);
          client.subscribe(rainTopic);
        },
        onFailure: function(err) {
          connStatusEl.textContent = "MQTT connect failed. Retrying...";
          console.error("MQTT connect failed:", err);
          setTimeout(connectMQTT, 3000);
        }
      };
      client.connect(options);
    }

    connectMQTT();
  </script>
</body>
</html>
