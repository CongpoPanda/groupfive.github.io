<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GROUP 5 ¬∑ IoT Weather Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- HiveMQ-style MQTT client (MQTT.js) -->
  <!-- Browser usage from HiveMQ docs: <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script> -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <style>
    :root {
      --bg: #020617;
      --bg2: #0b1220;
      --card: #020617;
      --border: #1f2937;
      --accent: #38bdf8;
      --accent2: #22c55e;
      --danger: #ef4444;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --shadow: 0 18px 45px rgba(0, 0, 0, 0.6);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1e293b 0, #020617 50%, #000 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1.2rem 1rem 2rem;
    }

    header {
      text-align: center;
      margin-bottom: 0.75rem;
    }

    header h1 {
      margin: 0;
      font-size: 1.6rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    header p {
      margin: 0.25rem 0 0.5rem;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .status-bar {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      justify-content: center;
      font-size: 0.8rem;
    }

    .pill {
      padding: 0.28rem 0.7rem;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid var(--border);
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      backdrop-filter: blur(8px);
    }

    .dot {
      width: 0.55rem;
      height: 0.55rem;
      border-radius: 999px;
      background: #6b7280;
      box-shadow: 0 0 8px transparent;
    }
    .dot.ok {
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.8);
    }
    .dot.err {
      background: #ef4444;
      box-shadow: 0 0 8px rgba(239, 68, 68, 0.8);
    }

    main {
      width: 100%;
      max-width: 980px;
      margin-top: 0.75rem;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
      gap: 1rem;
    }

    .card {
      position: relative;
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.16), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(56, 189, 248, 0.12), transparent 55%),
                  var(--card);
      border-radius: 1rem;
      border: 1px solid rgba(148, 163, 184, 0.18);
      padding: 0.9rem 1rem;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(148, 163, 184, 0.15), transparent 40%);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s;
    }

    .card:hover::before {
      opacity: 1;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.4rem;
    }

    .card-title {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    .card-icon {
      font-size: 1.3rem;
    }

    .value {
      font-size: 1.9rem;
      font-weight: 600;
      display: flex;
      align-items: baseline;
      gap: 0.25rem;
      margin: 0.1rem 0 0.2rem;
    }

    .unit {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .subtext {
      font-size: 0.78rem;
      color: var(--muted);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.15rem 0.55rem;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.85);
    }

    .badge.good {
      border-color: rgba(34, 197, 94, 0.7);
      color: #bbf7d0;
      background: rgba(22, 163, 74, 0.18);
    }

    .badge.warn {
      border-color: rgba(250, 204, 21, 0.7);
      color: #fef9c3;
      background: rgba(234, 179, 8, 0.18);
    }

    .badge.bad {
      border-color: rgba(239, 68, 68, 0.7);
      color: #fecaca;
      background: rgba(185, 28, 28, 0.18);
    }

    .emoji-big {
      font-size: 2.2rem;
      margin-top: 0.2rem;
    }

    .row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.3rem;
      font-size: 0.78rem;
      color: var(--muted);
    }

    .control-buttons {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .btn {
      flex: 1;
      padding: 0.35rem 0.5rem;
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 0.8rem;
      cursor: pointer;
      font-weight: 500;
      color: #0f172a;
      transition: transform 0.08s ease-out, box-shadow 0.12s, background 0.12s;
    }

    .btn:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: none;
    }

    .btn-on {
      background: linear-gradient(135deg, #22c55e, #4ade80);
      box-shadow: 0 8px 18px rgba(34, 197, 94, 0.45);
    }

    .btn-off {
      background: linear-gradient(135deg, #ef4444, #f97373);
      box-shadow: 0 8px 18px rgba(239, 68, 68, 0.45);
    }

    .btn[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
    }

    footer {
      margin-top: 1.25rem;
      font-size: 0.7rem;
      color: var(--muted);
      text-align: center;
    }
  </style>
</head>
<body>
  <header>
    <h1>GROUP 5 ¬∑ IoT Weather</h1>
    <p>ESP32 ¬∑ MQTT ¬∑ HiveMQ Cloud ¬∑ Live Environmental Dashboard</p>
    <div class="status-bar">
      <div class="pill">
        <span class="dot" id="mqtt-dot"></span>
        <span id="mqtt-status">MQTT: Connecting‚Ä¶</span>
      </div>
      <div class="pill">
        <span>Last update:</span>
        <span id="last-update">None</span>
      </div>
    </div>
  </header>

  <main>
    <div class="grid">
      <!-- Temperature -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Temperature</div>
          <div class="card-icon">üå°Ô∏è</div>
        </div>
        <div class="value">
          <span id="temp-value">--.-</span>
          <span class="unit">¬∞C</span>
        </div>
        <div class="row">
          <span class="subtext" id="temp-remark">Waiting for data‚Ä¶</span>
          <span class="badge" id="temp-badge">--</span>
        </div>
      </div>

      <!-- Humidity -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Humidity</div>
          <div class="card-icon">üíß</div>
        </div>
        <div class="value">
          <span id="hum-value">--.-</span>
          <span class="unit">%</span>
        </div>
        <div class="row">
          <span class="subtext" id="hum-remark">Waiting for data‚Ä¶</span>
          <span class="badge" id="hum-badge">--</span>
        </div>
      </div>

      <!-- Wind -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Wind</div>
          <div class="card-icon">üí®</div>
        </div>
        <div class="value">
          <span id="wind-speed-value">--.-</span>
          <span class="unit">m/s</span>
        </div>
        <div class="row">
          <span class="subtext">
            Direction: <strong id="wind-dir-value">--</strong>
          </span>
          <span class="badge" id="wind-badge">--</span>
        </div>
      </div>

      <!-- Rain -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Rain Status</div>
          <div class="card-icon">üå¶Ô∏è</div>
        </div>
        <div class="value">
          <span id="rain-text">--</span>
        </div>
        <div class="emoji-big" id="rain-emoji">‚òÅÔ∏è</div>
        <div class="row">
          <span class="subtext" id="rain-detail">Waiting for sensor‚Ä¶</span>
          <span class="badge" id="rain-badge">--</span>
        </div>
      </div>

      <!-- Air Pressure (Estimated from wind) -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Air Pressure (est.)</div>
          <div class="card-icon">üéà</div>
        </div>
        <div class="value">
          <span id="pressure-value">----</span>
          <span class="unit">hPa</span>
        </div>
        <div class="row">
          <span class="subtext">Estimated from wind speed</span>
          <span class="badge" id="pressure-badge">--</span>
        </div>
      </div>

      <!-- Weather Mood -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Weather Mood</div>
          <div class="card-icon" id="mood-emoji">üôÇ</div>
        </div>
        <div class="subtext" id="mood-text">
          Waiting for data from station‚Ä¶
        </div>
      </div>

      <!-- Remote Control Card -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Remote Control</div>
          <div class="card-icon">üïπÔ∏è</div>
        </div>
        <div class="subtext">
          Toggle station LED + buzzer from here.
        </div>
        <div class="control-buttons">
          <button class="btn btn-on" id="btn-on" onclick="sendLedCommand('ON')" disabled>
            ‚ö° Turn ON
          </button>
          <button class="btn btn-off" id="btn-off" onclick="sendLedCommand('OFF')" disabled>
            ‚èª Turn OFF
          </button>
        </div>
        <div class="row">
          <span class="subtext">LED Status:</span>
          <span class="badge" id="led-status-badge">Unknown</span>
        </div>
      </div>
    </div>
  </main>

  <footer>
    *IOT WEATHER MONITORING SYSTEM.  
    Built for CPE102 ¬∑ GROUP 5.
  </footer>

  <script>
    // -------- MQTT / HiveMQ Cloud config (MQTT.js) --------
    const MQTT_URL  = "wss://cef384719390434ea2501c6c4845c027.s1.eu.hivemq.cloud:8884/mqtt";

    const MQTT_USER = "LerDemo1";   // must match HiveMQ Cloud credentials
    const MQTT_PASS = "LerDemo1";

    const TOPIC_TEMP    = "cpe102/group5/temperature";
    const TOPIC_HUM     = "cpe102/group5/humidity";
    const TOPIC_WINDSPD = "cpe102/group5/windspeed";
    const TOPIC_WINDDIR = "cpe102/group5/winddir";
    const TOPIC_RAIN    = "cpe102/group5/rain";
    const TOPIC_LED     = "cpe102/group5/led";

    // -------- UI references --------
    const mqttDot     = document.getElementById("mqtt-dot");
    const mqttStatus  = document.getElementById("mqtt-status");
    const lastUpdate  = document.getElementById("last-update");

    const tempValue   = document.getElementById("temp-value");
    const tempBadge   = document.getElementById("temp-badge");
    const tempRemark  = document.getElementById("temp-remark");

    const humValue    = document.getElementById("hum-value");
    const humBadge    = document.getElementById("hum-badge");
    const humRemark   = document.getElementById("hum-remark");

    const windSpeedValue = document.getElementById("wind-speed-value");
    const windDirValue   = document.getElementById("wind-dir-value");
    const windBadge      = document.getElementById("wind-badge");

    const rainText    = document.getElementById("rain-text");
    const rainEmoji   = document.getElementById("rain-emoji");
    const rainDetail  = document.getElementById("rain-detail");
    const rainBadge   = document.getElementById("rain-badge");

    const pressureValue  = document.getElementById("pressure-value");
    const pressureBadge  = document.getElementById("pressure-badge");

    const moodEmoji   = document.getElementById("mood-emoji");
    const moodText    = document.getElementById("mood-text");

    const btnOn       = document.getElementById("btn-on");
    const btnOff      = document.getElementById("btn-off");
    const ledStatusBadge = document.getElementById("led-status-badge");

    let lastWindSpeed = 0;
    let ledLastState  = "Unknown";

    // -------- Helper functions --------
    function setBadge(el, text, type) {
      el.textContent = text;
      el.classList.remove("good", "warn", "bad");
      if (type) el.classList.add(type);
    }

    function nowTimeString() {
      const d = new Date();
      return d.toLocaleTimeString("en-PH", { hour12: false });
    }

    function estimatePressureFromWind(w) {
      let p = 1010 - (w * 1.8);
      if (p > 1015) p = 1015;
      if (p < 980)  p = 980;
      return p;
    }

    function updateMood() {
      const t = parseFloat(tempValue.textContent) || NaN;
      const h = parseFloat(humValue.textContent) || NaN;
      const rainRaw = rainText.textContent;

      let emoji = "üôÇ";
      let text = "Stable and calm conditions.";

      if (!isNaN(t) && !isNaN(h)) {
        if (rainRaw === "Raining") {
          emoji = "üåßÔ∏è";
          text  = "Rainy vibes. Bring an umbrella just in case!";
        } else if (t > 32 && h > 70) {
          emoji = "ü•µ";
          text  = "Hot and humid. Hydrate well!";
        } else if (t < 24 && h > 60) {
          emoji = "üåßÔ∏è";
          text  = "Cool and a bit moist, possible light rain.";
        } else if (t >= 24 && t <= 32 && h >= 40 && h <= 70) {
          emoji = "üòé";
          text  = "Nice weather! Sunny but still comfortable.";
        } else if (t < 22) {
          emoji = "üß•";
          text  = "Chilly air. Jacket weather!";
        }
      }

      moodEmoji.textContent = emoji;
      moodText.textContent  = text;
    }

    function updateLedStatus(state) {
      ledLastState = state;
      if (state === "ON") {
        setBadge(ledStatusBadge, "ON", "good");
      } else if (state === "OFF") {
        setBadge(ledStatusBadge, "OFF", "bad");
      } else {
        setBadge(ledStatusBadge, "Unknown", "");
      }
    }

    // -------- MQTT.js client setup --------
    console.log("Dashboard starting ‚Äî trying MQTT.js connect to", MQTT_URL);

    const client = mqtt.connect(MQTT_URL, {
      clean: true,
      connectTimeout: 4000,
      reconnectPeriod: 4000,
      username: MQTT_USER,
      password: MQTT_PASS
    });

    client.on("connect", () => {
      console.log("MQTT.js connected");
      mqttDot.classList.remove("err");
      mqttDot.classList.add("ok");
      mqttStatus.textContent = "MQTT: Connected";

      // subscribe to topics
      const topics = [TOPIC_TEMP, TOPIC_HUM, TOPIC_WINDSPD, TOPIC_WINDDIR, TOPIC_RAIN, TOPIC_LED];
      client.subscribe(topics, { qos: 0 }, (err, granted) => {
        if (err) {
          console.error("Subscribe error:", err);
        } else {
          console.log("Subscribed to:", granted.map(g => g.topic).join(", "));
        }
      });

      btnOn.disabled = false;
      btnOff.disabled = false;
      updateLedStatus("Unknown");
    });

    client.on("reconnect", () => {
      console.log("MQTT.js reconnecting‚Ä¶");
      mqttDot.classList.remove("ok");
      mqttDot.classList.add("err");
      mqttStatus.textContent = "MQTT: Reconnecting‚Ä¶";
      btnOn.disabled = true;
      btnOff.disabled = true;
    });

    client.on("close", () => {
      console.log("MQTT.js connection closed");
      mqttDot.classList.remove("ok");
      mqttDot.classList.add("err");
      mqttStatus.textContent = "MQTT: Disconnected";
      btnOn.disabled = true;
      btnOff.disabled = true;
    });

    client.on("error", (err) => {
      console.error("MQTT.js error:", err);
    });

    client.on("message", (topic, payloadBuf) => {
      const payload = payloadBuf.toString().trim();
      lastUpdate.textContent = nowTimeString();

      // Temperature
      if (topic === TOPIC_TEMP) {
        const v = parseFloat(payload);
        if (!isNaN(v)) {
          tempValue.textContent = v.toFixed(1);
          if (v < 24) {
            setBadge(tempBadge, "Cool", "good");
            tempRemark.textContent = "Medyo malamig pa sa labas.";
          } else if (v <= 32) {
            setBadge(tempBadge, "Comfortable", "good");
            tempRemark.textContent = "Saktong init lang.";
          } else {
            setBadge(tempBadge, "Mainit", "warn");
            tempRemark.textContent = "Ingat sa init, hydrate!";
          }
        }
      }

      // Humidity
      if (topic === TOPIC_HUM) {
        const v = parseFloat(payload);
        if (!isNaN(v)) {
          humValue.textContent = v.toFixed(1);
          if (v < 40) {
            setBadge(humBadge, "Dry", "warn");
            humRemark.textContent = "Medyo dry ang hangin.";
          } else if (v <= 70) {
            setBadge(humBadge, "Okay", "good");
            humRemark.textContent = "Comfortable humidity.";
          } else {
            setBadge(humBadge, "Humid", "warn");
            humRemark.textContent = "Malagkit na ang panahon.";
          }
        }
      }

      // Wind speed
      if (topic === TOPIC_WINDSPD) {
        const v = parseFloat(payload);
        if (!isNaN(v)) {
          lastWindSpeed = v;
          windSpeedValue.textContent = v.toFixed(2);
          if (v < 1.0) {
            setBadge(windBadge, "Calm", "good");
          } else if (v <= 5.0) {
            setBadge(windBadge, "Breezy", "good");
          } else {
            setBadge(windBadge, "Windy", "warn");
          }

          const p = estimatePressureFromWind(v);
          pressureValue.textContent = p.toFixed(1);
          if (p >= 1005) {
            setBadge(pressureBadge, "High-ish", "good");
          } else if (p >= 995) {
            setBadge(pressureBadge, "Normal", "good");
          } else {
            setBadge(pressureBadge, "Low-ish", "warn");
          }
        }
      }

      // Wind direction
      if (topic === TOPIC_WINDDIR) {
        windDirValue.textContent = payload || "--";
      }

      // Rain
      if (topic === TOPIC_RAIN) {
        if (payload === "RAIN") {
          rainText.textContent   = "Raining";
          rainEmoji.textContent  = "üåßÔ∏è";
          rainDetail.textContent = "Rain sensor detects water.";
          setBadge(rainBadge, "Wet", "bad");
        } else if (payload === "NO_RAIN") {
          rainText.textContent   = "Sunny";
          rainEmoji.textContent  = "‚òÄÔ∏è";
          rainDetail.textContent = "No rain detected, weather looks clear.";
          setBadge(rainBadge, "Dry", "good");
        } else {
          rainText.textContent   = "--";
          rainEmoji.textContent  = "‚òÅÔ∏è";
          rainDetail.textContent = "Sensor status unknown.";
          setBadge(rainBadge, "Unknown", "warn");
        }
      }

      // LED status echo
      if (topic === TOPIC_LED) {
        if (payload === "ON" || payload === "OFF") {
          updateLedStatus(payload);
        }
      }

      updateMood();
    });

    // -------- Publish control command --------
    function sendLedCommand(cmd) {
      if (!client.connected) {
        alert("MQTT not connected yet.");
        return;
      }
      client.publish(TOPIC_LED, cmd, { qos: 0, retain: false }, (err) => {
        if (err) {
          console.error("Failed to publish LED command:", err);
          alert("Failed to send command. See console.");
        } else {
          console.log("LED command sent:", cmd);
          updateLedStatus(cmd);
        }
      });
    }
  </script>
</body>
</html>
